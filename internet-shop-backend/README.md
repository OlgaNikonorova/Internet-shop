# Интернет - магазин

Система представляет собой интернет-магазин, предназначенный для продажи товаров пользователям. Она предоставляет функциональность для управления товарами, корзиной покупок, аутентификацией пользователей, а также рекомендациями товаров. Система построена на принципах REST API, использует JSON для обмена данными и JWT-токены для аутентификации. Пользователи могут просматривать каталог товаров, добавлять их в корзину, управлять своим профилем и получать персонализированные рекомендации.

Система оперирует следующими основными сущностями, которые связаны между собой:

- Пользователь (*User*). Представляет зарегистрированного пользователя магазина (покупателя или администратора).
- Товар (*Product*). Представляет товар, доступный для покупки в магазине.
- Корзина (*Cart*). Хранит товары, которые пользователь добавил для покупки.
- Элемент корзины (*CartItem*). Хранит информацию о добавленном товаре и собственную мета-информацию
- Избранные товары (*Favorite*). Представляет товар, добавленный в избранное с собственной метаинформацией
- Отзыв (*Review*).Представляет собой отзыв к товару, который может оставлять пользователь.


Основные разделы с эндпоинтами:

- Пользователи `api/users/`
- Авторизация `api/auth`
- Товары `api/products`
- Корзина товаров `api/cart`
- Избранное `api/favorites`
- Отзывы `api/reviews`


# Необходимые шаги для запуска сервера

1. Установить зависимости
2. Запустить проект

## Установка зависимостей

```bash
$ npm install
```

## Запуск проекта

```bash
# development
$ npm run start
```

# Документация

После запуска сервера доступна спецификация openAPI и asyncAPI.

- openAPI доступен по адресу `http://localhost:3000/api`
- asyncAPI доступен по адресу `http://localhost:3000/async-api`


# Aвторизация

Эндпоинт: `api/users`

Авторизация отвечает за управление аутентификацией и авторизацией пользователей. Она позволяет пользователям регистрироваться, входить в систему, обновлять токены доступа, выходить из системы, а также запрашивать и выполнять сброс пароля. Все эндпоинты используют JSON для обмена данными, за исключением случаев, когда требуется загрузка файлов (например, аватара при регистрации). Авторизация и аутентификация основана на JWT.

Система использует 3 роли:

- Обычный пользователь (user)
- Администратор (admin)
- Продавец (Seller)

Администратор полностью управляет возможностью системы. Продавец не может управлять операциями, связанными с пользователями.

# Товары

Эндпоинт: `api/products`

Система предоставляет функциональность для создания, получения, обновления, удаления и массового обновления товаров, а также для получения списка товаров с поддержкой пагинации, фильтрации и множественной сортировки. Некоторые операции (создание, обновление, удаление, массовое обновление) доступны только администраторам и продавцам. Модуль также интегрирован с системой рекомендаций, отправляя уведомления через WebSocket, когда пользователь запрашивает конкретный товар.

## Получение рекомендаций по веб - сокетам

Система использует WebSocket для отправки персонализированных рекомендаций товаров пользователю, основанных на категории просматриваемого товара. Рекомендации отправляются через RecommendationsGateway, когда пользователь запрашивает информацию о конкретном товаре через эндпоинт `GET /products/:id` используя JWT - авторизацию.

Пример подключения Javascript

```javasript
const socket = new WebSocket('ws://localhost:3000/recommendations', [], {
  headers: {
    Authorization: 'Bearer <accessToken>'
  }
});

socket.onopen = () => {
  console.log('WebSocket connection established');
};

socket.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('Received message:', message);
};

socket.onclose = () => {
  console.log('WebSocket connection closed');
};

socket.onerror = (error) => {
  console.error('WebSocket error:', error);
};
```

- Адрес для подключения (URL): `ws://localhost:3000/recommendations`
- При подключении необходимо передать JWT-токен в заголовке Authorization в формате Bearer `<accessToken>`.
- Токен можно получить через эндпоинт POST /auth/login или POST /auth/refresh.

После успешного соединения, отправляется сообщение:

```json
{
  "event": "connected",
  "data": {
    "userId": <userId>
  }
}
```

Рекомендации отправляются автоматически, когда пользователь запрашивает товар через эндпоинт `GET /products/:id`.

Пример ответа:

```json
{
  "event": "recommendations",
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174001",
      "name": "Smartphone",
      "price": 699.99,
      "category": "DecorativeCosmetics",
      "images": ["/uploads/smartphone1.jpg"]
    },
    {
      "id": "123e4567-e89b-12d3-a456-426614174002",
      "name": "Headphones",
      "price": 199.99,
      "category": "DecorativeCosmetics",
      "images": ["/uploads/headphones1.jpg"]
    }
  ]
}
```

Если токен отсутствует, недействителен или истек, клиент получает сообщение и соединение закрывается.

```json
{
  "event": "error",
  "data": {
    "message": "Unauthorized"
  }
}
```

Ещё для проверки, можно послать тестовое сообщение "ping" и получить ответ.

Сообщение:

```json
{
    "event": "ping"
}
```

Ответ:

```json
{
    "event": "pong",
    "data": {
        "timestamp": "2025-05-07T14:23:01.181Z"
    }
}
```

# Корзина

Эндпоинт: `api/cart`

Корзина товаров предоставляет функциональность для управления корзиной покупок пользователя. Пользователи могут просматривать товары в корзине, добавлять новые товары, изменять их количество, удалять товары или полностью очищать корзину. Все операции требуют аутентификации пользователя через JWT-токен, так как корзина привязана к конкретному пользователю. Эндпоинты используют JSON для обмена данными.


# Избранное

Эндпоинт: `api/favorites`

Избранное отвечает за управление списком избранных товаров пользователя. Пользователи могут добавлять товары в избранное, удалять их, просматривать список избранных товаров с поддержкой пагинации и фильтрации, а также очищать весь список. Все операции требуют аутентификации, так как избранное привязано к конкретному пользователю. Сущность Favorite связывает пользователя (User) и товар (Product), обеспечивая возможность хранения и управления списком избранных товаров.


# Пользователи

Эндпоинт: `api/users`

Система дает возможность управлять пользователями в интернет-магазине. Она предоставляет функциональность для получения информации о пользователях (включая текущего пользователя), обновления данных, изменения ролей, бана/разбана, удаления, а также массового обновления ролей или статусов. Большинство операций доступны только администраторам, за исключением получения профиля текущего пользователя, которое доступно любому аутентифицированному пользователю. Все операции требуют аутентификации через JWT-токен.

Базовые пользователи для входа:

- Администратор

```json
{
  "password": "password123",
  "username": "john_doe"
}
```

- Продавец

```json
{
  "password": "password123",
  "username": "john_seller"
}
```

- Обычный пользователь

```json
{
  "password": "password123",
  "username": "john_user"
}
```

# Отзывы о товаре

Эндпоинт: `api/reviews`

Аутентифицированные пользователи могут создавать отзывы о товарах, обновлять или удалять свои отзывы, а также просматривать все отзывы для конкретного товара или конкретный отзыв по его ID. Каждый отзыв включает оценку (от 1 до 5 звезд) и комментарий. Система автоматически обновляет средний рейтинг и количество отзывов для товара после операций с отзывами. Все операции требуют аутентификации через JWT-токен, а обновление и удаление отзывов разрешены только автору отзыва. Эндпоинты используют JSON для обмена данными.
